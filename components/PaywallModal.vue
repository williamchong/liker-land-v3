<template>
  <UModal
    :title="$t('pricing_page_subscription')"
    :description="$t('pricing_page_subscription_description')"
    :fullscreen="isFullscreenModal"
    :dismissible="props.isBackdropDismissible"
    :transition="props.hasTransition"
    :modal="isModalityOn"
    :ui="{ content: modalContentClass }"
    @update:open="onOpenUpdate"
  >
    <template #content>
      <UButton
        v-if="!props.isCloseButtonHidden"
        icon="i-material-symbols-close"
        :class="[
          'absolute',
          'z-10',
          'top-0 phone:top-4',
          'right-0 phone:right-4',
          'max-phone:scale-75',
          'max-laptop:text-white',
          'cursor-pointer',
        ]"
        variant="link"
        size="md"
        @click="handleCloseButtonClick"
      />
      <template v-if="isDesktopScreen && isShowTTSSamples">
        <aside class="relative flex justify-end w-full bg-theme-cyan min-h-max">
          <div class="flex flex-col justify-center items-center relative w-full max-w-[512px] min-h-max bg-theme-black">
            <PlusBlocktrendBundleBanner
              v-if="isBlocktrendCampaign"
              class="w-full shrink-0"
              :is-force-landscape="true"
              :is-dark-background="true"
            />
            <PricingPageCampaignMedia
              v-else-if="campaignContent"
              class="w-full shrink-0"
              :campaign-id="campaignContent.id"
              orientation="landscape"
            />
            <div :class="['p-12', { 'pt-30': !campaignContent }]">
              <img
                v-if="!campaignContent"
                :src="plusLogo"
                :alt="$t('pricing_page_title')"
                class="w-full max-w-[300px] laptop:max-h-[200px] mb-12 object-contain"
              >

              <PricingPageIntroSection
                class="w-full max-w-[420px]"
                :is-dark-background="true"
                :title="campaignContent?.title"
                :description="campaignContent?.description"
              />
            </div>
          </div>
        </aside>
      </template>
      <template v-else>
        <PlusBlocktrendBundleBanner
          v-if="isBlocktrendCampaign"
          class="max-laptop:shrink-0 w-full min-h-max"
        />
        <aside
          v-else-if="campaignContent"
          class="relative max-laptop:shrink-0 w-full min-h-max bg-theme-black"
        >
          <div class="max-laptop:hidden absolute inset-0 overflow-hidden">
            <PricingPageCampaignMedia
              class="absolute inset-x-0 w-full top-1/2 -translate-y-1/2"
              :campaign-id="campaignContent.id"
              orientation="portrait"
            />
          </div>
          <PricingPageCampaignMedia
            class="laptop:hidden w-full"
            :campaign-id="campaignContent.id"
            orientation="landscape"
          />
        </aside>
        <aside
          v-else
          class="relative flex justify-center items-center max-laptop:shrink-0 w-full p-12 bg-theme-black overflow-hidden"
        >
          <img
            :src="plusLogo"
            :alt="$t('pricing_page_title')"
            class="w-full max-w-[300px] laptop:max-h-[200px] object-contain"
          >
        </aside>
      </template>

      <div
        :class="[
          'flex',
          'w-full',
          { 'items-center': !isShowTTSSamples || campaignContent },
          'min-h-max',
        ]"
      >
        <div
          :class="[
            'w-full',
            'max-w-[512px]',
            'max-laptop:mx-auto',
            'p-5 laptop:p-12',
            campaignContent ? 'max-laptop:pt-8' : 'laptop:pt-30',
          ]"
        >
          <PricingPageIntroSection
            v-if="!(isShowTTSSamples && isDesktopScreen)"
            class="mb-8"
            :title="campaignContent?.title"
            :description="campaignContent?.description"
          />
          <TTSSamplesSection v-if="isShowTTSSamples" />

          <!-- Price Select -->
          <div class="flex flex-col w-full mt-12">
            <div class="flex flex-col gap-4">
              <!-- Yearly plan -->
              <label
                :class="[
                  ...planLabelBaseClass,
                  selectedPlan === 'yearly' ? 'border-black' : 'border-gray-200',
                ]"
              >
                <div
                  v-if="yearlyDiscountPercent"
                  class="absolute -top-3 left-1/6 -translate-x-1/2 bg-black text-theme-cyan text-xs font-semibold px-3 py-1 rounded-lg"
                  v-text="$t('pricing_page_yearly_discount', { discount: yearlyDiscountPercent })"
                />

                <div class="flex items-center">
                  <div class="w-6 h-6 shrink-0 mr-4">
                    <div
                      :class="[
                        'w-full h-full rounded-full border flex items-center justify-center',
                        selectedPlan === 'yearly' ? 'bg-black' : 'bg-white border-gray-300',
                      ]"
                    >
                      <UIcon
                        v-if="selectedPlan === 'yearly'"
                        name="i-material-symbols-check"
                        class="bg-theme-cyan"
                        size="16"
                      />
                    </div>
                  </div>
                  <div
                    class="text-md font-semibold whitespace-nowrap"
                    v-text="$t('pricing_page_yearly')"
                  />
                </div>
                <div class="text-right">
                  <div
                    v-if="hasYearlyDiscount"
                    class="flex justify-end items-center gap-2 text-sm text-gray-400"
                  >
                    <p v-text="$t('pricing_page_original_price')" />
                    <span
                      class="line-through text-gray-400"
                      v-text="`US$${originalYearlyPrice}`"
                    />
                  </div>
                  <i18n-t
                    keypath="pricing_page_price_per_year"
                    tag="div"
                    class="flex items-baseline text-sm whitespace-nowrap"
                  >
                    <template #price>
                      <p
                        class="text-2xl font-bold px-1"
                        v-text="`$${yearlyPrice}`"
                      />
                    </template>
                  </i18n-t>
                </div>
                <input
                  v-model="selectedPlan"
                  type="radio"
                  name="plan"
                  value="yearly"
                  class="hidden"
                >
              </label>

              <!-- Monthly plan -->
              <label
                :class="[
                  ...planLabelBaseClass,
                  selectedPlan === 'monthly' ? 'border-black' : 'border-gray-200',
                ]"
              >
                <div class="flex items-center">
                  <div class="w-6 h-6 flex-shrink-0 mr-4">
                    <div
                      class="w-full h-full rounded-full border flex items-center justify-center bg-black"
                      :class="selectedPlan === 'monthly' ? 'bg-black' : 'bg-white border-gray-300'"
                    >
                      <UIcon
                        v-if="selectedPlan === 'monthly'"
                        name="i-material-symbols-check"
                        class="bg-theme-cyan"
                        size="16"
                      />
                    </div>
                  </div>
                  <div
                    class="text-md font-semibold whitespace-nowrap"
                    v-text="$t('pricing_page_monthly')"
                  />
                </div>

                <div class="text-right">
                  <div
                    v-if="hasMonthlyDiscount"
                    class="flex justify-end items-center gap-2 text-sm text-gray-400"
                  >
                    <p v-text="$t('pricing_page_original_price')" />
                    <span
                      class="line-through text-gray-400"
                      v-text="`US$${originalMonthlyPrice}`"
                    />
                  </div>
                  <i18n-t
                    keypath="pricing_page_price_per_month"
                    tag="div"
                    class="flex items-baseline text-sm whitespace-nowrap"
                  >
                    <template #price>
                      <p
                        class="text-2xl font-bold px-1"
                        v-text="`$${monthlyPrice}`"
                      />
                    </template>
                  </i18n-t>
                </div>

                <input
                  v-model="selectedPlan"
                  type="radio"
                  name="plan"
                  value="monthly"
                  class="hidden"
                >
              </label>
            </div>

            <UButton
              class="mt-4"
              :label="subscribeButtonLabel"
              block
              size="xl"
              :loading="props.isProcessingSubscription"
              :ui="{ base: 'py-2 laptop:py-3 rounded-2xl cursor-pointer', label: 'font-bold' }"
              @click="handleSubscribeButtonClick"
            />
          </div>
        </div>
      </div>
    </template>
  </UModal>
</template>

<script setup lang="ts">
import type { PaywallModalProps } from './PaywallModal.props'

import plusLogo from '~/assets/images/paywall/plus-logo.png'

const isDesktopScreen = useDesktopScreen()

// NOTE: When the dialog's modality is set to true, interaction with elements outside the dialog is disabled.
// Therefore, we set modality to false so input in the Magic login UI remains accessible.
const isModalityOn = false

const emit = defineEmits<{
  'open': []
  'close': []
  'subscribe': [payload: {
    trialPeriodDays?: number
    mustCollectPaymentMethod?: boolean
    selectedPlan: SubscriptionPlan
    utmCampaign?: string
    utmMedium?: string
    utmSource?: string
  }]
  'update:modelValue': [value: SubscriptionPlan]
}>()

const props = withDefaults(
  defineProps<PaywallModalProps>(),
  {
    isFullscreen: false,
    isBackdropDismissible: true,
    hasTransition: true,
    isCloseButtonHidden: false,
    isProcessingSubscription: false,
  },
)

const { t: $t } = useI18n()
const isScreenSmall = useMediaQuery('(max-width: 1023px)')
const {
  monthlyPrice,
  yearlyPrice,
  originalMonthlyPrice,
  originalYearlyPrice,
  yearlyDiscountPercent,
  hasMonthlyDiscount,
  hasYearlyDiscount,
} = useSubscriptionPricing()
const getRouteQuery = useRouteQuery()

const shouldShowTTSSamples = computed(() => {
  return getRouteQuery('samples') === '1'
})

const abTest = shouldShowTTSSamples.value
  ? undefined
  : useABTest({
      experimentKey: 'pricing-page-tts-sample',
    })

const isShowTTSSamples = computed(() => shouldShowTTSSamples.value || abTest?.isVariant('tts-sample'))

const utmCampaign = computed(() => {
  return getRouteQuery('utm_campaign') || props.utmCampaign
})
const campaignId = computed(() => {
  return getRouteQuery('utm_term') || utmCampaign.value
})

const {
  campaignContent,
  isBlocktrendCampaign,
} = usePricingPageCampaign({ campaignId })

const isFullscreenModal = computed(() => props.isFullscreen || isScreenSmall.value)

const modalContentClass = computed(() => {
  const classes = [
    'flex',
    'flex-col',
    'laptop:flex-row',
    'items-stretch',
    'w-full',
    'divide-y-0',
    'rounded-none',
    '!overflow-x-hidden',
  ]
  if (!isFullscreenModal.value) {
    classes.push(
      'max-w-[420px] laptop:max-w-[840px]',
      'laptop:rounded-2xl',
    )
  }
  return classes.join(' ')
})

// NOTE: This could be simplified by computed, but props not updated after `open()` in `useOverlay()`
const selectedPlan = ref(props.modelValue || 'yearly')
watch(
  selectedPlan,
  value => emit('update:modelValue', value),
)

const planLabelBaseClass = [
  'relative',
  'flex',
  'justify-between',
  'items-center',
  'px-4',
  'py-4',
  'rounded-2xl',
  'border-2',
  'cursor-pointer',
  'transition-all',
  'duration-200',
  'ease-in-out',
  'hover:shadow-lg',
  'hover:border-gray-400',
]

const subscribeButtonLabel = computed(() => {
  if (props.trialPeriodDays) {
    return $t('pricing_page_start_trial_button', { days: props.trialPeriodDays })
  }
  return $t('pricing_page_continue_button')
})

onMounted(() => {
  emit('open')

  if (campaignContent.value) {
    useLogEvent(`pricing_page_campaign_${campaignContent.value.id}`)
  }
})

const onOpenUpdate = (open: boolean) => {
  if (open) {
    emit('open')
  }
  else {
    emit('close')
  }
}

const handleCloseButtonClick = () => {
  emit('close')
}

function handleSubscribeButtonClick() {
  emit('subscribe', {
    selectedPlan: selectedPlan.value,
    mustCollectPaymentMethod: props.mustCollectPaymentMethod,
    trialPeriodDays: props.trialPeriodDays,
    utmCampaign: utmCampaign.value,
    utmMedium: props.utmMedium,
    utmSource: props.utmSource,
  })
}
</script>
